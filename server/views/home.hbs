<header class="topbar">
  <button class="icon-btn" id="menuBtn" aria-label="Open menu">
    <span class="hamburger"></span>
  </button>

  <div class="brand">ARC</div>

  <div class="topbar-right" id="whoami">Not logged in</div>
</header>

<aside class="drawer" id="drawer">
  <div class="drawer-head">
    <div class="drawer-title">Account</div>
    <button class="icon-btn" id="closeBtn" aria-label="Close menu">✕</button>
  </div>

  <div class="drawer-body">
    <div class="drawer-user" id="drawerUser">Guest</div>

    <div class="drawer-actions">
      <a class="drawer-link" href="/login" id="loginLink">Login</a>
      <a class="drawer-link" href="/register" id="registerLink">Register</a>
      <button class="drawer-link danger" id="logoutBtn" style="display:none;">Logout</button>
    </div>
  </div>
</aside>

<div class="backdrop" id="backdrop"></div>

<main class="main">
  <div class="home-anchor">
    <section class="stat-card">
      <div class="stat-card-head">
        <div class="stat-card-title">Stats</div>
        <div class="stat-card-sub" id="subTitle">Baseline</div>
      </div>

      <div class="radar-wrap">
        <svg class="radar" viewBox="0 0 300 300" role="img" aria-label="Stats radar chart">
          <polygon class="grid" points="150,35 258,115 216,245 84,245 42,115"></polygon>
          <polygon class="grid" points="150,60 237,125 204,225 96,225 63,125"></polygon>
          <polygon class="grid" points="150,85 216,135 192,205 108,205 84,135"></polygon>

          <line class="axis" x1="150" y1="150" x2="150" y2="35"></line>
          <line class="axis" x1="150" y1="150" x2="258" y2="115"></line>
          <line class="axis" x1="150" y1="150" x2="216" y2="245"></line>
          <line class="axis" x1="150" y1="150" x2="84" y2="245"></line>
          <line class="axis" x1="150" y1="150" x2="42" y2="115"></line>

          <polygon class="value" id="valuePoly"
            points="150,70 225,132 190,220 110,210 78,132"></polygon>

          <text class="label" x="150" y="22" text-anchor="middle">STR</text>
          <text class="label" x="275" y="112" text-anchor="start">INT</text>
          <text class="label" x="232" y="270" text-anchor="middle">END</text>
          <text class="label" x="68" y="270" text-anchor="middle">CHA</text>
          <text class="label" x="25" y="112" text-anchor="end">WIS</text>
        </svg>
      </div>

      <div class="stat-list">
        <div class="stat-row">
          <span class="stat-name">STR</span>
          <span class="stat-val" id="s_str">-</span>
          <button class="stat-plus" data-stat="str" aria-label="Generate STR quest">+</button>
        </div>

        <div class="stat-row">
          <span class="stat-name">INT</span>
          <span class="stat-val" id="s_int">-</span>
          <button class="stat-plus" data-stat="int" aria-label="Generate INT quest">+</button>
        </div>

        <div class="stat-row">
          <span class="stat-name">END</span>
          <span class="stat-val" id="s_end">-</span>
          <button class="stat-plus" data-stat="end" aria-label="Generate END quest">+</button>
        </div>

        <div class="stat-row">
          <span class="stat-name">CHA</span>
          <span class="stat-val" id="s_cha">-</span>
          <button class="stat-plus" data-stat="cha" aria-label="Generate CHA quest">+</button>
        </div>

        <div class="stat-row">
          <span class="stat-name">WIS</span>
          <span class="stat-val" id="s_wis">-</span>
          <button class="stat-plus" data-stat="wis" aria-label="Generate WIS quest">+</button>
        </div>
      </div>


      <div class="quest-actions">
        <div id="questOut" class="quest-out muted"></div>
      </div>

    </section>

    <section class="quest-panel">
      <div class="quest-panel-head">
        <div class="quest-panel-title">Active Quest</div>
        <div class="quest-panel-sub muted" id="questPanelSub">Generate a quest to begin.</div>
      </div>

      <div id="questCardArea" class="quest-panel-body">
        <div class="muted">No quest loaded.</div>
      </div>
    </section>
  </div>
</main>

<script>
  const drawer = document.getElementById("drawer");
  const backdrop = document.getElementById("backdrop");
  const menuBtn = document.getElementById("menuBtn");
  const closeBtn = document.getElementById("closeBtn");

  const whoami = document.getElementById("whoami");
  const drawerUser = document.getElementById("drawerUser");
  const logoutBtn = document.getElementById("logoutBtn");
  const loginLink = document.getElementById("loginLink");
  const registerLink = document.getElementById("registerLink");

  function openDrawer() {
    drawer.classList.add("open");
    backdrop.classList.add("show");
  }
  function closeDrawer() {
    drawer.classList.remove("open");
    backdrop.classList.remove("show");
  }

  menuBtn.addEventListener("click", openDrawer);
  closeBtn.addEventListener("click", closeDrawer);
  backdrop.addEventListener("click", closeDrawer);

  logoutBtn.addEventListener("click", async () => {
    await fetch("/api/auth/logout", { method: "POST" });
    window.location.href = "/login";
  });

  const questOut = document.getElementById("questOut");
  const questCardArea = document.getElementById("questCardArea");
  const questPanelSub = document.getElementById("questPanelSub");

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function setStatUI(user) {
    document.getElementById("s_str").textContent = user.str;
    document.getElementById("s_int").textContent = user.int;
    document.getElementById("s_end").textContent = user.end;
    document.getElementById("s_cha").textContent = user.cha;
    document.getElementById("s_wis").textContent = user.wis;
    document.getElementById("subTitle").textContent = `Level ${user.level} · ${user.xp} XP`;
  }

  async function loadStats() {
    const res = await fetch("/api/user/me");
    if (!res.ok) return;
    const { user } = await res.json();
    setStatUI(user);
  }

  function renderQuestCard(q) {
    const title = escapeHtml(q.title);
    const desc = escapeHtml(q.description);
    const stat = escapeHtml(q.stat);

    questPanelSub.textContent = `${stat.toUpperCase()} quest · Difficulty ${q.difficulty}`;

    questCardArea.innerHTML = `
      <div class="qcard">
        <div class="qcard-title">${title}</div>
        <div class="qcard-meta">${stat.toUpperCase()} · Difficulty ${q.difficulty} · +${q.xpReward} XP</div>
        <div class="qcard-desc">${desc}</div>

        <div class="qcard-actions">
          <button class="qbtn" id="completeQuestBtn" data-id="${q.id}">
            Complete Quest
          </button>
          <div class="muted" id="questMsg"></div>
        </div>
      </div>
    `;

    document.getElementById("completeQuestBtn").addEventListener("click", async (e) => {
      const btn = e.target;
      const questId = btn.dataset.id;
      const msg = document.getElementById("questMsg");

      btn.disabled = true;
      btn.textContent = "Completing...";

      const res = await fetch(`/api/quests/${questId}/complete`, { method: "POST" });
      const text = await res.text();
      let data;
      try { data = JSON.parse(text); } catch { data = { raw: text }; }

      if (!res.ok) {
        btn.disabled = false;
        btn.textContent = "Complete Quest";
        msg.textContent = data.error || `Error ${res.status}`;
        return;
      }

      msg.textContent = `Completed! +${data.gainedXp} XP, +1 ${String(data.stat).toUpperCase()}`;

      if (data.user) setStatUI(data.user);
      await loadStats();

      btn.textContent = "Completed";
    });
  }

  fetch("/api/auth/me")
    .then(r => r.json())
    .then(data => {
      if (data.user) {
        const name = data.user.username || data.user.email;
        whoami.textContent = name;
        drawerUser.textContent = name;
        logoutBtn.style.display = "inline-block";
        loginLink.style.display = "none";
        registerLink.style.display = "none";
      } else {
        whoami.textContent = "Guest";
      }
    })
    .catch(() => whoami.textContent = "Guest");

  async function generateQuestFor(stat) {

    document.querySelectorAll(".stat-plus").forEach(b => b.disabled = true);

    let res;
    try {
      res = await fetch("/api/quests/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ stat })
      });
    } catch {
      questOut.textContent = "Network error talking to server";
      document.querySelectorAll(".stat-plus").forEach(b => b.disabled = false);
      return;
    }

    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch { data = { raw: text }; }

    document.querySelectorAll(".stat-plus").forEach(b => b.disabled = false);

    if (!res.ok) {
      questOut.textContent =
        (data.error || `Error ${res.status}`) +
        (data.raw ? `: ${String(data.raw).slice(0,120)}` : "");
      return;
    }

    renderQuestCard(data.quest);
  }

  document.querySelectorAll(".stat-plus").forEach(btn => {
    btn.addEventListener("click", () => generateQuestFor(btn.dataset.stat));
  });


  // Initial load
  loadStats();
</script>
